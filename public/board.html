<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ê²Œì‹œíŒ Â· Freetalk</title>
<link rel="icon" href="/img/icon1101.png">
<meta name="theme-color" content="#0b1020"/>
<style>
:root{--bg:#0b1020;--panel:#121831;--ink:#e5e7eb;--muted:#9aa3b2;--bd:#1f2745;
--accent:#7c3aed;--accent2:#8b5cf6;--radius:14px;--max:1100px}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0b1020,#0f1530);color:var(--ink);
  font:15px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Malgun Gothic,sans-serif}
.wrap{max-width:var(--max);margin:20px auto;padding:0 16px}
.head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.badge{border:1px solid var(--bd);border-radius:999px;padding:5px 9px;font-size:12px;color:#c7d2fe;background:#0e1430}
.panel{background:linear-gradient(180deg,#121831,#0f142d);border:1px solid var(--bd);border-radius:var(--radius);
  box-shadow:0 12px 36px rgba(0,0,0,.35);padding:12px}

/* table */
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{padding:10px 10px;border-bottom:1px solid #1f274a;vertical-align:middle}
.table th{color:#cbd5e1;font-size:13px;text-align:center;background:#0f1632;position:sticky;top:0;z-index:1}
.table tr:hover td{background:#10183a}
.title a{color:#e9edff;text-decoration:none}
.title a:hover{color:#fff;text-decoration:underline}
.meta{color:var(--muted);font-size:12px}
.tools{display:flex;gap:6px;align-items:center}
.btn{border:1px solid var(--bd);background:#0d1430;color:#e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,var(--accent2),var(--accent));border-color:#6d28d9}
.pager{display:flex;gap:8px;justify-content:center;margin-top:12px}
@media (max-width:760px){
  .table .col-date,.table .col-views,.table .col-author{display:none}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div>
      <h2 id="board-name" style="margin:0 0 4px 0">ì „ì²´ ê¸€ë³´ê¸°</h2>
      <div class="meta"><span id="board-desc">ëª¨ë“  ê²Œì‹œê¸€ì´ í‘œì‹œë©ë‹ˆë‹¤.</span></div>
    </div>
    <div class="tools">
      <button class="btn" onclick="history.back()">â† ë’¤ë¡œ</button>
      <a class="btn primary" href="/posting.html">ê¸€ì“°ê¸°</a>
    </div>
  </div>

  <div class="panel">
    <table class="table" id="post-table" aria-describedby="board-name">
      <thead>
        <tr>
          <th style="width:64px">êµ¬ë¶„</th>
          <th>ì œëª©</th>
          <th class="col-author" style="width:160px">ì‘ì„±ì</th>
          <th class="col-date" style="width:140px">ì‘ì„±ì¼</th>
          <th class="col-views" style="width:90px;text-align:right">ì¡°íšŒìˆ˜</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="5" class="meta">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr></tbody>
    </table>

    <div class="pager">
      <button id="prev" class="btn" disabled>ì´ì „</button>
      <button id="next" class="btn">ë‹¤ìŒ</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, collection, query, where, orderBy, limit, getDocs, startAfter
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const cfg={apiKey:"AIzaSyACn_-2BLztKYmBKXtrKNtMsC-2Y238oug",
authDomain:"woori-1ecf5.firebaseapp.com",projectId:"woori-1ecf5"};
const app=initializeApp(cfg); const db=getFirestore(app);

const $=s=>document.querySelector(s);
const esc=s=>String(s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]||m));
const fmt=t=>{try{const d=t?.toDate?.()||new Date();const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${y}.${m}.${da}`;}catch{return '';}};
const params=new URL(location.href).searchParams;
const boardId=params.get('board')||''; // '' = ì „ì²´
const PAGE=20;

let cursor=null, stack=[]; // pagination

async function loadBoardMeta(){
  $('#board-name').textContent = 'ì „ì²´ ê¸€ë³´ê¸°';
  $('#board-desc').textContent = 'ëª¨ë“  ê²Œì‹œê¸€ì´ í‘œì‹œë©ë‹ˆë‹¤.';
  if(!boardId) return;
  // boards/{id}ê°€ ìˆë‹¤ë©´ ì´ë¦„/ì„¤ëª… ì‚¬ìš©
  try{
    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js");
    const d = await getDoc(doc(db,'boards',boardId));
    if (d.exists()){
      const b=d.data();
      $('#board-name').textContent=b.name||'ê²Œì‹œíŒ';
      $('#board-desc').textContent=b.slug?`/${b.slug}`:'';
    }
  }catch{}
}
loadBoardMeta();

function rowHTML(x,id){
  const hasImg=(Array.isArray(x.images)&&x.images.length>0);
  const notice = x.isNotice ? 'ê³µì§€' : '';
  const tag = notice || (x.category||'');
  return `
    <tr>
      <td>${tag?`<span class="badge">${esc(tag)}</span>`:''}</td>
      <td class="title">
        <a href="post-view.html?id=${encodeURIComponent(id)}">
          ${hasImg ? 'ğŸ–¼ ' : ''}${esc(x.title||'(ì œëª© ì—†ìŒ)')}
          ${x.commentCount?` <span class="meta">[${x.commentCount}]</span>`:''}
        </a>
      </td>
      <td class="col-author">${esc(x.authorName||'ìµëª…')}</td>
      <td class="col-date">${fmt(x.createdAt)}</td>
      <td class="col-views" style="text-align:right">${x.views||0}</td>
    </tr>`;
}

async function fetchPage(next=false){
  let q = query(collection(db,'communityPosts'), orderBy('createdAt','desc'), limit(PAGE));
  if (boardId){
    q = query(collection(db,'communityPosts'),
      where('boardId','==',boardId), orderBy('createdAt','desc'), limit(PAGE));
  }
  if(next && cursor) q = query(q, startAfter(cursor));

  const snap = await getDocs(q);
  const rows = [];
  snap.forEach(d=>rows.push({ id:d.id, ...d.data() }));

  // í…Œì´ë¸” ë Œë”
  const tb=$('#tbody');
  if(rows.length===0){
    tb.innerHTML = `<tr><td colspan="5" class="meta">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
  }else{
    tb.innerHTML = rows.map(r=>rowHTML(r,r.id)).join('');
  }

  // í˜ì´ì§€ ìŠ¤íƒ/ì»¤ì„œ
  $('#prev').disabled = stack.length===0;
  if(rows.length < PAGE){ $('#next').disabled=true; } else { $('#next').disabled=false; }
  if(rows.length>0) cursor = rows[rows.length-1].createdAt;
  // next ì´ë™ ì‹œ ì´ì „ ì»¤ì„œë¥¼ ìŒ“ê¸°
  if(next) stack.push(rows[0]?.createdAt || null);
}

$('#next').addEventListener('click', ()=>fetchPage(true));
$('#prev').addEventListener('click', async ()=>{
  if(stack.length===0) return;
  const prevCursor = stack.pop();
  // prev: ë‹¤ì‹œ ì²˜ìŒë¶€í„° prevCursor ì§ì „ê¹Œì§€ ê±´ë„ˆë›°ëŠ” ê°„ë‹¨ ë°©ì‹
  cursor = null;
  $('#next').disabled=false;
  // ì²˜ìŒ í˜ì´ì§€ ì¬ë¡œë”©
  fetchPage(false);
});

fetchPage(false);
</script>
</body>
</html>
